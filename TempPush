blueprint:
  domain: automation
  name: Sonoff TRVZB External Temperature Sensor Calibration
  description: |
    ## Sonoff TRVZB External Temperature Sensor Calibration (v1.0.3)

    Synchronises external room temperature (e.g. Sonoff SNZB-02) to one or more Sonoff TRVZB valves.

    Triggers:
    - On sensor state change
    - Heartbeat: checks every minute, and re-pushes temperature when the current minute is divisible by the configured interval.

  input:
    external_temperature_sensor:
      name: External Temperature Sensor
      description: The entity representing the external room temperature.
      selector:
        entity:
          filter:
            - domain: sensor
              device_class: temperature

    trv_external_temperature_input:
      name: Sonoff TRVZB(s)
      description: The external temperature input entity of one or more TRVs.
      selector:
        entity:
          multiple: true
          filter:
            - domain: number
              device_class: temperature

    heartbeat_minutes:
      name: Heartbeat interval (minutes)
      description: >
        How often to re-send the temperature even if it hasn't changed.
        Recommended: 5â€“15 minutes.
      default: 10
      selector:
        number:
          min: 1
          max: 60
          step: 1
          unit_of_measurement: minutes
          mode: slider

triggers:
  # Trigger when the sensor updates
  - trigger: state
    entity_id: !input external_temperature_sensor

  # Heartbeat tick: every minute (we'll filter using a condition)
  - trigger: time_pattern
    minutes: "/1"

variables:
  external_temperature_sensor: !input external_temperature_sensor
  heartbeat_minutes: !input heartbeat_minutes

conditions:
  # Only run on the heartbeat trigger when minute % heartbeat == 0
  - condition: template
    value_template: >
      {% if trigger.platform == 'time_pattern' %}
        {{ (now().minute % (heartbeat_minutes | int(10))) == 0 }}
      {% else %}
        true
      {% endif %}

  # Only run if we have a valid numeric temperature
  - condition: template
    value_template: >
      {{ states(external_temperature_sensor) | is_number }}

actions:
  - action: number.set_value
    data:
      value: "{{ states(external_temperature_sensor) | float }}"
      entity_id: !input trv_external_temperature_input

mode: single
